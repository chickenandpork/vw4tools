BEGIN { ecount = 0; FS=","; HOLDNAME=""; HOLDTYPE=""; printf "{\n  \"version\" : 1,\n   \"entities\" : [\n"; }

func dumpAccum()
{
	if (0 < ecount) printf ",\n";
	ecount++;

	printf "   {\n";
	printf "      \"name\" : \"%s\",\n",HOLDNAME;
	if ("array" == HOLDTYPE)
	    printf "      \"type\" : \"storagearray\",\n";
	else if ("host" == HOLDTYPE)
	    printf "      \"type\" : \"host\",\n";
	else
	    printf "      \"type\" : \"unknown\",\n";

	printf "      \"tags\" : [ \"csv2json Import\" ],\n";
	printf "      \"edit_type\" : \"add\",\n";
	printf "      \"child_entities\" : { \"add\" : [ ";

	cecount = 0;
	if ("host" == HOLDTYPE)
	  for (a in ACCUM)
	  {
		if (0 < cecount) printf ", ";
		if (ACCUM[a] == HOLDNAME) printf "\"%s-%02d\"", HOLDNAME, cecount;
		else printf "\"%s\"", ACCUM[a];
		cecount++;
	  }
	else
	  for (a in ACCUM)
	  {
		if (0 == cecount) printf "\"%s\"", a;
		else printf ", \"%s\"", a;
		cecount++;
	  };
	printf " ] }\n";

	cecount = 0;
	if ("host" == HOLDTYPE)
	  for (a in ACCUM)
	  {
	if (ACCUM[a] == HOLDNAME) printf "   },\n   {\n      \"name\" : \"%s-%02d\",\n",HOLDNAME, cecount;
	else printf "   },\n   {\n      \"name\" : \"%s\",\n", ACCUM[a];
	printf "      \"type\" : \"hba\",\n";
	printf "      \"edit_type\" : \"add\",\n";
	printf "      \"child_entities\" : { \"add\" : [ \"%s\" ] }\n", a;
		cecount++;
	  }


	printf "   }";

	HOLDNAME=$1;
	HOLDTYPE=$2;
	delete ACCUM;
	if ("" == $4) ACCUM[$3]=$1; else ACCUM[$3]=$4;
}

(("" == HOLDNAME) && ("" == HOLDTYPE)) { HOLDNAME=$1; HOLDTYPE=$2; }
(($1 == HOLDNAME) && ($2 == HOLDTYPE)) { if ("" == $4) ACCUM[$3]=$1; else ACCUM[$3]=$4; next; }

{ dumpAccum() }

END { dumpAccum(); printf "\n]\n}\n"; }

