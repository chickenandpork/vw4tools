AT_INIT()


AT_SETUP(version)
dnl      ------

AT_CHECK([java -jar $abs_top_builddir/convjars/@PACKAGE@.jar --version], 0, [stdout], [])

AT_CLEANUP()



AT_SETUP(csv-to-json awk script)
dnl      ----------------------

dnl 50:0A:09:85:98:D2:6B:D5 NetApp-d26bd5-iGrp1-0e
AT_DATA([c2v01.csv], [NetApp-123456,array,50:0A:09:85:98:12:34:56
NetApp-123456,array,50:0A:09:86:98:12:34:56
Oracle01,host,10:00:00:00:c9:12:34:56
Oracle01,host,10:00:00:00:c9:12:34:57
])

AT_CHECK([@AWK@ -f $abs_top_builddir/scripts/csv-to-json.awk c2v01.csv], 0, [[{
  "version" : 1,
   "entities" : [
   {
      "name" : "NetApp-123456",
      "type" : "storagearray",
      "tags" : [ "csv2json Import" ],
      "edit_type" : "add",
      "child_entities" : { "add" : [ "NetApp-123456-00", "NetApp-123456-01" ] }
   },
   {
      "name" : "NetApp-123456-00",
      "type" : "iomodule",
      "tags" : [ "csv2json Import" ],
      "edit_type" : "add",
      "child_entities" : { "add" : [ "50:0A:09:86:98:12:34:56" ] }
   },
   {
      "name" : "NetApp-123456-01",
      "type" : "iomodule",
      "tags" : [ "csv2json Import" ],
      "edit_type" : "add",
      "child_entities" : { "add" : [ "50:0A:09:85:98:12:34:56" ] }
   },
   {
      "name" : "Oracle01",
      "type" : "host",
      "tags" : [ "csv2json Import" ],
      "edit_type" : "add",
      "child_entities" : { "add" : [ "Oracle01-00", "Oracle01-01" ] }
   },
   {
      "name" : "Oracle01-00",
      "type" : "hba",
      "tags" : [ "csv2json Import" ],
      "edit_type" : "add", 
      "child_entities" : { "add" : [ "10:00:00:00:c9:12:34:56" ] }
   },
   {
      "name" : "Oracle01-01",
      "type" : "hba",
      "tags" : [ "csv2json Import" ],
      "edit_type" : "add", 
      "child_entities" : { "add" : [ "10:00:00:00:c9:12:34:57" ] }
   }
]
}
]], [])

AT_DATA([c2v02.csv], [Oracle01,host,10:00:00:00:c9:12:34:56,Oracle01-A
Oracle01,host,10:00:00:00:c9:12:34:57,Oracle01-B
])

AT_CHECK([@AWK@ -f $abs_top_builddir/scripts/csv-to-json.awk c2v02.csv], 0, [[{
  "version" : 1,
   "entities" : [
   {
      "name" : "Oracle01",
      "type" : "host",
      "tags" : [ "csv2json Import" ],
      "edit_type" : "add",
      "child_entities" : { "add" : [ "Oracle01-A", "Oracle01-B" ] }
   },
   {
      "name" : "Oracle01-A",
      "type" : "hba",
      "tags" : [ "csv2json Import" ],
      "edit_type" : "add", 
      "child_entities" : { "add" : [ "10:00:00:00:c9:12:34:56" ] }
   },
   {
      "name" : "Oracle01-B",
      "type" : "hba",
      "tags" : [ "csv2json Import" ],
      "edit_type" : "add", 
      "child_entities" : { "add" : [ "10:00:00:00:c9:12:34:57" ] }
   }
]
}
]], [])

AT_DATA([c2v03.csv], [NetApp-123456,array,50:0A:09:85:98:12:34:56,NetApp-Blue-iGrp1-0e
NetApp-123456,array,50:0A:09:86:98:12:34:56,NetApp-Blue-iGrp1-0f
])

AT_CHECK([@AWK@ -f $abs_top_builddir/scripts/csv-to-json.awk c2v03.csv], 0, [[{
  "version" : 1,
   "entities" : [
   {
      "name" : "NetApp-123456",
      "type" : "storagearray",
      "tags" : [ "csv2json Import" ],
      "edit_type" : "add",
      "child_entities" : { "add" : [ "NetApp-Blue-iGrp1-0f", "NetApp-Blue-iGrp1-0e" ] }
   },
   {
      "name" : "NetApp-Blue-iGrp1-0f",
      "type" : "iomodule",
      "tags" : [ "csv2json Import" ],
      "edit_type" : "add", 
      "child_entities" : { "add" : [ "50:0A:09:86:98:12:34:56" ] }
   },
   {
      "name" : "NetApp-Blue-iGrp1-0e",
      "type" : "iomodule",
      "tags" : [ "csv2json Import" ],
      "edit_type" : "add", 
      "child_entities" : { "add" : [ "50:0A:09:85:98:12:34:56" ] }
   }
]
}
]], [])

AT_CHECK([@AWK@ -v SKIPARRAY="barkbark" -f $abs_top_builddir/scripts/csv-to-json.awk c2v03.csv], 0, [[{
  "version" : 1,
   "entities" : [
   {
      "name" : "NetApp-Blue-iGrp1-0f",
      "type" : "iomodule",
      "tags" : [ "csv2json Import" ],
      "edit_type" : "add", 
      "child_entities" : { "add" : [ "50:0A:09:86:98:12:34:56" ] }
   },
   {
      "name" : "NetApp-Blue-iGrp1-0e",
      "type" : "iomodule",
      "tags" : [ "csv2json Import" ],
      "edit_type" : "add", 
      "child_entities" : { "add" : [ "50:0A:09:85:98:12:34:56" ] }
   }
]
}
]], [])

AT_CLEANUP()



AT_SETUP(csv-to-json awk script dirtydata)
dnl      --------------------------------

AT_DATA([c2v01.csv], ["NetApp-123456",array,50:0A:09:85:98:12:34:56
" Oracle01",host,"10:00:00:00:c9:12:34:56"
])

AT_CHECK([@AWK@ -f $abs_top_builddir/scripts/csv-to-json.awk c2v01.csv], 0, [[{
  "version" : 1,
   "entities" : [
   {
      "name" : "NetApp-123456",
      "type" : "storagearray",
      "tags" : [ "csv2json Import" ],
      "edit_type" : "add",
      "child_entities" : { "add" : [ "NetApp-123456-00" ] }
   },
   {
      "name" : "NetApp-123456-00",
      "type" : "iomodule",
      "tags" : [ "csv2json Import" ],
      "edit_type" : "add",
      "child_entities" : { "add" : [ "50:0A:09:85:98:12:34:56" ] }
   },
   {
      "name" : "Oracle01",
      "type" : "host",
      "tags" : [ "csv2json Import" ],
      "edit_type" : "add",
      "child_entities" : { "add" : [ "Oracle01-00" ] }
   },
   {
      "name" : "Oracle01-00",
      "type" : "hba",
      "tags" : [ "csv2json Import" ],
      "edit_type" : "add",
      "child_entities" : { "add" : [ "10:00:00:00:c9:12:34:56" ] }
   }
]
}
]], [])

AT_CLEANUP()



AT_SETUP(local testcase)
dnl      --------------

AT_CHECK([if test x@USERTESTCASE@ = xmissing ; then exit 77; fi])

AT_CLEANUP()



AT_SETUP(Doxygen confirmation of marked-up content)
dnl      -----------------------------------------

AT_CHECK([if test x@DOXYGEN@ = xmissing ; then exit 77; fi])
AT_CHECK([make -C $abs_top_builddir doc], 0, [ignore],[stderr])
dnl used to put the errors at the bottom of the output
AT_CHECK([cat stderr], 0, [],[])

AT_CLEANUP()


